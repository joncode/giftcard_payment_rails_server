require 'spec_helper'
require 'rake'

describe "Slicktext.rake" do

    before(:each) do
        CampaignItem.delete_all
        Campaign.delete_all
        @sample_response = "{\"meta\":{\"limit\":20,\"offset\":0,\"total\":2},\"links\":{\"self\":\"http://api.slicktext.com/v1/contacts/\"},\"contacts\":[{\"id\":11111,\"number\":\"+5555555555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555525555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"(555)255-5555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+3555555555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555555552\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555445555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555555225\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555551111\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555555551\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5155555555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+2135555555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555555235\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5355455555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555555515\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555155555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5155555115\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555551555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555555755\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5556556555\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"},{\"id\":11111,\"number\":\"+5555555566\",\"city\":\"null\",\"state\":\"null\",\"zipCode\":\"null\",\"country\":\"null\",\"textword\":\"itsonme\",\"subscribedDate\":\"2013-02-04 21:12:45\",\"firstName\":\"null\",\"lastName\":\"null\",\"birthDate\":\"null\"}]}"
    end

    xit "should create gift_campaign objs - one for each phone number" do
        textword = "itsonme"
        provider = FactoryGirl.create(:provider)
        campaign = FactoryGirl.create(:campaign)
        cam_item = FactoryGirl.create(:campaign_item, campaign_id: campaign.id, textword: textword, provider_id: provider.id)

        route = SLICKTEXT_URL + "/#{textword}/contacts?limit=1000"
        stub_request(:get, route).with(:body => "data=", :headers => {'Accept'=>'application/json', 'Authorization'=>"#{SLICKTEXT_API_KEY}"}).to_return(:status => 200, :body => @sample_response )

        Rake::Task["promo:slicktext"].invoke

        gifts = Gift.where(cat: 300)
        gifts.count.should == 20
        phones = gifts.map { |g| g.receiver_phone }
        phones.uniq.count.should == 20
    end
end