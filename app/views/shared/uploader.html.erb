<script type="text/javascript">
  function showPreview(coords){
  	//Fill in the preview information
  	var origPicWidth = $("#imageCanvas").width();
  	var origPicHeight = $("#imageCanvas").height();
  	var previewWidth = $("#preview").width();
  	var previewHeight = $("#preview").height();
	
  	var widthScale = origPicWidth / coords.w;
  	var heightScale = origPicHeight / coords.h;
	
  	var bgSizeWidth = widthScale * previewWidth;
  	var bgSizeHeight = heightScale * previewHeight;
  	var newBgSize = bgSizeWidth+"px "+bgSizeHeight+"px";
  	$("#preview").css("backgroundSize",newBgSize);
	
  	var bgPosX = coords.x * (widthScale/(origPicWidth/previewWidth));
  	var bgPosY = coords.y * (heightScale/(origPicHeight/previewHeight));
  	var newBgPos = "-"+bgPosX+"px -"+bgPosY+"px"
  	$("#preview").css("backgroundPosition",newBgPos);
	
  	$("#crop_coord_x").val(coords.x);
  	$("#crop_coord_y").val(coords.y);
  	$("#crop_coord_w").val(coords.w);
  	$("#crop_coord_h").val(coords.h);
  }


  $(document).ready(function(){
    var imageLoader = document.getElementById('<%= @obj_name %>_<%= @file_field_name %>');
        imageLoader.addEventListener('change', handleImage, false);

    var maxHeight = 500;
    var maxWidth = 350;
    function handleImage(e){
      $("#imageCanvas").remove();
      $(".jcrop-holder").remove();
      $("#upload_wrapper").append('<canvas id="imageCanvas"></canvas>');
      var canvas = document.getElementById("imageCanvas");
      var ctx = canvas.getContext('2d');
      
      var reader = new FileReader();
      reader.onload = function(event){
        var img = new Image();
        img.onload = function(){
          var canvasHeight = img.height;
          var canvasWidth = img.width;
          
          //Test for scaling
          var dxy = 1;
          if (canvasHeight > maxHeight){
            dxy = maxHeight/canvasHeight;
            canvasHeight = maxHeight;
            canvasWidth = dxy*canvasWidth;
          }
          if (canvasWidth > maxWidth){
            var txy = maxWidth/canvasWidth;
            canvasWidth = maxWidth;
            canvasHeight = txy*canvasHeight;
            dxy = txy*dxy;
          }
          canvas.width = canvasWidth;
          canvas.height = canvasHeight;
          ctx.scale(dxy,dxy);
          ctx.drawImage(img,0,0);
          var cssData = "url('"+canvas.toDataURL()+"')";
          $("#preview").css("backgroundImage",cssData);
          //Set up the cropper
          var jcrop_api;
					$('#imageCanvas').Jcrop({
						onChange: showPreview,
						onSelect: showPreview,
						aspectRatio: <%= @obj_width / @obj_height %>
					}, function(){ jcrop_api = this; });
					jcrop_api.setSelect([0,0,canvas.width,canvas.height]);
        }
        img.src = event.target.result;
      }
      reader.readAsDataURL(e.target.files[0]);     
    }
  });
</script>
<style type="text/css">
	#uploaded_photo{
		width: 350px; height: 500px; background: #ddd; float: left; display: table;
	}
	#uploaded_photo #inner_wrapper{
		display: table-cell; vertical-align: middle;
	}
	#uploaded_photo #inner_wrapper .jcrop-holder{
		margin: 0px auto; display: block; background-color: gray !important;
	}
	#preview{
		width: <%= @obj_width%>px; height: <%= @obj_height %>px; background: gray;
	}
  #upload_wrapper {
    background-color: #444;
    color: white;
  }
	#crop_coord_x,#crop_coord_y,#crop_coord_w,#crop_coord_h{ display: none; }
</style>

<%= form_for(@obj_to_edit, :url => {:action => @action}, :html => { :method => :post, :id => 'uploadForm', :multipart => true }) do |f| %>
  <div class="row">
    <div class="span5" id="upload_wrapper">
       Upload a file: <%= f.file_field @file_field_name %>
       <% %w[x y w h].each do |attr| %>
         <input id="crop_coord_<%= attr %>" type="text" size="30" name="<%= @obj_name %>[crop_<%= attr %>]">
       <% end %>
    </div>
    <div class="span4"><div class="photoContainer">
      <div id="preview" style=""></div>
  <div class="profilePic"><%= custom_image_tag @obj_to_edit, @obj_width, @obj_height, @file_field_name %></div>
  </div>
      <br/>
      <div class="actions">
        <%= f.submit "Upload Photo" %>
      </div>
      
    </div>
  </div>  
<% end %>